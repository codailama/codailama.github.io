<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> #IssueFix : Too many Hive Staging Directories everywhere · Codailama</title><meta name="description" content="#IssueFix : Too many Hive Staging Directories everywhere - Santosh Pingale"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Codailama"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/pages/resume" target="_self" class="nav-list-link">RESUME</a></li><li class="nav-list-item"><a href="https://github.com/santosh-d3vpl3x" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">#IssueFix : Too many Hive Staging Directories everywhere</h1><div class="post-info">Mar 4, 2015</div><div class="post-content"><h2 id="issue-description"><a href="#Issue-Description" class="headerlink" title="Issue Description:"></a>Issue Description: <a href="#issue-description" class="header-anchor">#</a></h2><p>While working with Hive, we noticed that there are too many directories with name <code>.hive-staging_hive_yyyy-MM-dd_HH-mm-ss_SSS_xxxx-x</code> in the table location directories. These directories were added to the location with execution of each query.</p>
<p>At the same time, few users were facing problems like access permission issues on table directories even when each table had read access for all users and groups.</p>
<p>Error while compiling statement: FAILED: RuntimeException Cannot create staging directory &#x2018;hdfs://namenode:8020/path/to/table/hive-staging_hive_yyyy-MM-dd_HH-mm-ss_SSS_xxxx-x&#x2019;: Permission denied: user=uname, access=WRITE, inode=&#x201D;hdfs://namenode:8020/path/to/table&#x201D;:uname2:hive:drwxrwxr-x at&#x2026;&#x2026;.</p>
<a id="more"></a>
<h2 id="rca"><a href="#RCA" class="headerlink" title="RCA:"></a>RCA: <a href="#rca" class="header-anchor">#</a></h2><p>While investigating the issue, we found every hive query was trying to treat table location as the Hive staging directory. Ideally it should be somewhere in the <code>/tmp</code> directory in HDFS. Users facing access problems were the ones which did not had write access to the table location which again is valid as you do not want everyone to mess with the data.</p>
<p>After doing some search, we found out that other CDH users were also facing this issue and they had already come up with work around for the issue. This article expains the root cause analysis of the issue.</p>
<h3 id="solution"><a href="#Solution" class="headerlink" title="Solution:"></a>Solution: <a href="#solution" class="header-anchor">#</a></h3><p>We had to change few properties for Hive which are located in <code>hive-site.xml</code>. We used Cloudera Manger web configuration section of Hive to do it. Safety valves were changed for all roles in Hive service. So non data platform team memebers were able to execute query without any issues and no <code>.hive-staging</code> directories were being created in table location. But still this issue persisted when the queries were executed from Hive Cli. So we had to change the safety valve for client configurations as well. After deploying the configurations cluster wide, the issue disappeared.</p>
<p><strong>Configurations:</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#xA0;<span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">&#xA0; &#xA0; <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.exec.stagingdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">&#xA0; &#xA0; <span class="tag">&lt;<span class="name">value</span>&gt;</span>/tmp/hive-staging/.hive<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">&#xA0; <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>OR<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">&#xA0;&#xA0;&#xA0;<span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.exec.stagingdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">&#xA0;&#xA0;&#xA0;<span class="tag">&lt;<span class="name">value</span>&gt;</span>${hive.exec.scratchdir}<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>Use second property configuration if data security is of high importance!!<br><strong>What Broke it:</strong><br>We recently upgraded our cluster to CDH 5.3 and it has Hive encryption feature in place. Hive uses  the encryption provided by HDFS. Because of limitations put forth by HDFS encryption,  the table location HDFS directory is used as hive staging directory and hence it broke previous hive settings.</p>
<h3 id="references"><a href="#References" class="headerlink" title="References:"></a>References: <a href="#references" class="header-anchor">#</a></h3><ul>
<li><a href="https://groups.google.com/a/cloudera.org/forum/#!topic/cdh-user/ebuF_9_RODQ" target="_blank" rel="external">https://groups.google.com/a/cloudera.org/forum/#!topic/cdh-user/ebuF_9_RODQ</a></li>
<li><a href="http://community.cloudera.com/t5/Batch-SQL-Apache-Hive/CDH-5-3-Hive-staging-directory-has-wrong-default-value/td-p/23585" target="_blank" rel="external">http://community.cloudera.com/t5/Batch-SQL-Apache-Hive/CDH-5-3-Hive-staging-directory-has-wrong-default-value/td-p/23585</a></li>
<li><a href="https://issues.apache.org/jira/browse/HIVE-5207" target="_blank" rel="external">https://issues.apache.org/jira/browse/HIVE-5207</a></li>
<li><a href="http://www.cloudera.com/content/cloudera/en/documentation/core/latest/topics/cdh_sg_component_kms.html#concept_gmj_n3d_np_unique_1" target="_blank" rel="external">http://www.cloudera.com/content/cloudera/en/documentation/core/latest/topics/cdh_sg_component_kms.html#concept_gmj_n3d_np_unique_1</a></li>
<li><a href="https://issues.apache.org/jira/browse/HIVE-8065" target="_blank" rel="external">https://issues.apache.org/jira/browse/HIVE-8065</a></li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2015/03/04/hdfs-expained-as-comic/" class="prev">上一篇</a><a href="/2015/03/04/hdfs-how-file-is-written/" class="next">下一篇</a></div><div class="copyright"><p>© 2013 - 2016 <a href="http://yoursite.com">Santosh Pingale</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>