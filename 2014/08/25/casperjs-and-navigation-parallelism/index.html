<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> CasperJS and Navigation Parallelism · Codailama</title><meta name="description" content="CasperJS and Navigation Parallelism - Santosh Pingale"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Codailama"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/pages/resume" target="_self" class="nav-list-link">RESUME</a></li><li class="nav-list-item"><a href="https://github.com/santosh-d3vpl3x" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">CasperJS and Navigation Parallelism</h1><div class="post-info">Aug 25, 2014</div><div class="post-content"><p>This tutorial will describe how <a href="http://casperjs.org/" target="_blank" rel="external">CasperJS</a> can be used to scrape/test multiple pages at a time. CasperJS is a navigation scripting and testing utility. It&#x2019;s execution takes place in sequential manner, in which one navigation step executes after other. For small number of steps, this behavior of CasperJS is perfectly fine. But as number of steps increase, the amount of time consumed can become very huge. This problem can be solved by introducing parallelism in the execution of navigation steps.<br><a id="more"></a></p>
<div class="toc">

<!-- toc -->
<ul>
<li><a href="#mission-of-this-tutorial">Mission of This Tutorial</a><ul>
<li><a href="#main-problem">Main Problem:</a></li>
</ul>
</li>
<li><a href="#getting-started">Getting Started</a><ul>
<li><a href="#google-scraping-for-a-single-keyword">Google Scraping : For a single keyword</a></li>
</ul>
</li>
<li><a href="#google-scraping-for-multiple-keywords">Google Scraping : For Multiple keywords</a></li>
<li><a href="#google-scraping-for-multiple-keywords-using-array">Google Scraping : For Multiple keywords, using array</a><ul>
<li><a href="#solutions">Solutions:</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
</div>

<blockquote>
<p>Setup guide for CasperJS: <a href="http://casperjs.readthedocs.org/en/latest/installation.html" target="_blank" rel="external">CasperJS Official setup guide</a></p>
</blockquote>
<h2 id="mission-of-this-tutorial"><a href="#Mission-of-This-Tutorial" class="headerlink" title="Mission of This Tutorial"></a>Mission of This Tutorial <a href="#mission-of-this-tutorial" class="header-anchor">#</a></h2><h3 id="main-problem"><a href="#Main-Problem" class="headerlink" title="Main Problem:"></a>Main Problem: <a href="#main-problem" class="header-anchor">#</a></h3><p>Scraping search results from the first page for a keyword of google.<br>This problem statement can be divided into multiple parts:</p>
<ul>
<li>Scrape results for a single keyword.</li>
<li>Scrape results for multiple keywords in sequential manner.</li>
<li>Introduce parallelism to the previous step.</li>
<li>Address issues, if any.</li>
</ul>
<h2 id="getting-started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started <a href="#getting-started" class="header-anchor">#</a></h2><p>Lets begin with the scraping results for a single keyword.</p>
<h3 id="google-scraping-for-a-single-keyword"><a href="#Google-Scraping-For-a-single-keyword" class="headerlink" title="Google Scraping : For a single keyword"></a>Google Scraping : For a single keyword <a href="#google-scraping-for-a-single-keyword" class="header-anchor">#</a></h3><p>A simple code to open Google search engine results for keyword facebook and then scrape results from first page looks like .</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> results = {};</div><div class="line"><span class="keyword">var</span> casper = <span class="built_in">require</span>(<span class="string">&apos;casper&apos;</span>).create();</div><div class="line"><span class="comment">//It is important that you set the user-agent. Google uses it to render their pages.</span></div><div class="line">casper.userAgent(<span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64)&quot;</span>+</div><div class="line"><span class="string">&quot; AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.107 Safari/537.36&quot;</span>);</div><div class="line"></div><div class="line"><span class="comment">//Get all the links</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLinks</span>(<span class="params"></span>) </span>{</div><div class="line"><span class="keyword">var</span> links = <span class="built_in">document</span>.querySelectorAll(<span class="string">&apos;h3.r a&apos;</span>);</div><div class="line"><span class="keyword">return</span> <span class="built_in">Array</span>.prototype.map.call(links, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>{</div><div class="line"> <span class="keyword">return</span> e.getAttribute(<span class="string">&apos;href&apos;</span>);</div><div class="line">});</div><div class="line">}</div><div class="line"><span class="comment">//Add scraped links to results variable</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addScrapedLinksToResults</span>(<span class="params">query</span>)</span>{</div><div class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</div><div class="line">  <span class="keyword">var</span> links = <span class="keyword">this</span>.evaluate(getLinks);</div><div class="line">  <span class="keyword">this</span>.echo(<span class="built_in">JSON</span>.stringify(query));</div><div class="line">  <span class="keyword">this</span>.echo(query +<span class="string">&quot; &quot;</span>+ links.join(<span class="string">&quot;,&quot;</span>));</div><div class="line">  results[query] = links;</div><div class="line"> }</div><div class="line">}</div><div class="line"><span class="keyword">var</span> query = <span class="string">&apos;google&apos;</span>;</div><div class="line"><span class="comment">//We will be using this link instead of form submission.</span></div><div class="line"><span class="comment">//form submission is now based on instant search.</span></div><div class="line"><span class="comment">//As there is no event for html re-rendering, </span></div><div class="line"><span class="comment">//it is going to be difficult to know whether results for the new keyword </span></div><div class="line"><span class="comment">//has rendered or not. </span></div><div class="line"><span class="keyword">var</span> url = <span class="string">&apos;https://www.google.co.in/search?q=&apos;</span>+query;</div><div class="line"></div><div class="line">casper.start();</div><div class="line"></div><div class="line">casper.thenOpen(url);</div><div class="line"></div><div class="line">casper.then(addScrapedLinksToResults(query));</div><div class="line"></div><div class="line">casper.run(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</div><div class="line"><span class="comment">// echo results in some pretty fashion</span></div><div class="line"> <span class="keyword">this</span>.echo(<span class="string">&apos;Done&apos;</span>);</div><div class="line"> <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> results){</div><div class="line"> <span class="keyword">this</span>.echo(results[key].length + <span class="string">&apos; links found for &apos;</span>+ key +<span class="string">&apos;:&apos;</span>);</div><div class="line"> <span class="keyword">this</span>.echo(<span class="string">&apos; - &apos;</span> + results[key].join(<span class="string">&apos;\n - &apos;</span>));</div><div class="line">}</div><div class="line"><span class="keyword">this</span>.exit();</div><div class="line">});</div></pre></td></tr></table></figure>
<p>Save this file as <code>simple-google-scrape.js</code>in bin folder of CasperJS. Run it using following command.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">casperjs simple-google-scrape.js</div></pre></td></tr></table></figure>
<p>Console will display all the scraped links from the first page.</p>
<h2 id="google-scraping-for-multiple-keywords"><a href="#Google-Scraping-For-Multiple-keywords" class="headerlink" title="Google Scraping : For Multiple keywords"></a>Google Scraping : For Multiple keywords <a href="#google-scraping-for-multiple-keywords" class="header-anchor">#</a></h2><p>By simply adding multiple <code>casper.thenOpen(url)</code> before<code>casper.run()</code> multiple result pages can be scraped.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> results = {};</div><div class="line"><span class="keyword">var</span> casper = <span class="built_in">require</span>(<span class="string">&apos;casper&apos;</span>).create();</div><div class="line">casper.userAgent(<span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64)&quot;</span>+</div><div class="line"><span class="string">&quot; AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.107 Safari/537.36&quot;</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLinks</span>(<span class="params"></span>) </span>{</div><div class="line"><span class="keyword">var</span> links = <span class="built_in">document</span>.querySelectorAll(<span class="string">&apos;h3.r a&apos;</span>);</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.prototype.map.call(links, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>{</div><div class="line">        <span class="keyword">return</span> e.getAttribute(<span class="string">&apos;href&apos;</span>);</div><div class="line">    });</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addScrapedLinksToResults</span>(<span class="params">query</span>)</span>{</div><div class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</div><div class="line">    <span class="keyword">var</span> links = <span class="keyword">this</span>.evaluate(getLinks);</div><div class="line">    <span class="keyword">this</span>.echo(<span class="built_in">JSON</span>.stringify(query));</div><div class="line">    <span class="keyword">this</span>.echo(query +<span class="string">&quot; &quot;</span>+ links.join(<span class="string">&quot;,&quot;</span>));</div><div class="line">    results[query] = links;</div><div class="line">}</div><div class="line">}</div><div class="line"><span class="keyword">var</span> query = <span class="string">&apos;google&apos;</span>;</div><div class="line"><span class="keyword">var</span> url = <span class="string">&apos;https://www.google.co.in/search?q=&apos;</span>+query;</div><div class="line"></div><div class="line">casper.start();</div><div class="line"></div><div class="line">casper.thenOpen(url);</div><div class="line"></div><div class="line">casper.then(addScrapedLinksToResults(query));</div><div class="line">query = <span class="string">&apos;facebook&apos;</span>;</div><div class="line">url = <span class="string">&apos;https://www.google.co.in/search?q=&apos;</span>+query;</div><div class="line"></div><div class="line">casper.thenOpen(url);</div><div class="line"></div><div class="line">casper.then(addScrapedLinksToResults(query));</div><div class="line"></div><div class="line">casper.run(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</div><div class="line"><span class="comment">// echo results in some pretty fashion</span></div><div class="line"><span class="keyword">this</span>.echo(<span class="string">&apos;Done&apos;</span>);</div><div class="line"><span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> results){</div><div class="line">    <span class="keyword">this</span>.echo(results[key].length + <span class="string">&apos; links found for &apos;</span>+ key +<span class="string">&apos;:&apos;</span>);</div><div class="line">    <span class="keyword">this</span>.echo(<span class="string">&apos; - &apos;</span> + results[key].join(<span class="string">&apos;\n - &apos;</span>));</div><div class="line">}</div><div class="line"><span class="keyword">this</span>.exit();</div><div class="line">});</div></pre></td></tr></table></figure></p>
<h2 id="google-scraping-for-multiple-keywords-using-array"><a href="#Google-Scraping-For-Multiple-keywords-using-array" class="headerlink" title="Google Scraping : For Multiple keywords, using array"></a>Google Scraping : For Multiple keywords, using array <a href="#google-scraping-for-multiple-keywords-using-array" class="header-anchor">#</a></h2><p>Each <code>thenOpen</code> and <code>then</code> call adds a navigation step to the execution stack of CasperJS. Code for scraping results of multiple keywords can easily be tweaked with array of keywords. For more information on Navigation steps:<a href="http://stackoverflow.com/questions/11604611/what-does-then-really-mean-in-casperjs" target="_blank" rel="external">What Does &#x2018;Then&#x2019; Really Mean in CasperJS</a><br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> results = {};</div><div class="line"><span class="keyword">var</span> casper = <span class="built_in">require</span>(<span class="string">&apos;casper&apos;</span>).create();</div><div class="line">casper.userAgent(<span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64)&quot;</span>+</div><div class="line"><span class="string">&quot; AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.107 Safari/537.36&quot;</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLinks</span>(<span class="params"></span>) </span>{</div><div class="line"><span class="keyword">var</span> links = <span class="built_in">document</span>.querySelectorAll(<span class="string">&apos;h3.r a&apos;</span>);</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.prototype.map.call(links, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>{</div><div class="line">        <span class="keyword">return</span> e.getAttribute(<span class="string">&apos;href&apos;</span>);</div><div class="line">    });</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addScrapedLinksToResults</span>(<span class="params">query</span>)</span>{</div><div class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</div><div class="line">    <span class="keyword">var</span> links = <span class="keyword">this</span>.evaluate(getLinks);</div><div class="line">    <span class="keyword">this</span>.echo(<span class="built_in">JSON</span>.stringify(query));</div><div class="line">    <span class="keyword">this</span>.echo(query +<span class="string">&quot; &quot;</span>+ links.join(<span class="string">&quot;,&quot;</span>));</div><div class="line">    results[query] = links;</div><div class="line">}</div><div class="line">}</div><div class="line"><span class="keyword">var</span> query = [<span class="string">&apos;google&apos;</span>,<span class="string">&apos;facebook&apos;</span>,<span class="string">&apos;twitter&apos;</span>,<span class="string">&apos;pinterest&apos;</span>,<span class="string">&apos;whatsapp&apos;</span>,<span class="string">&apos;skype&apos;</span>];</div><div class="line"></div><div class="line">casper.start();</div><div class="line"></div><div class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&amp;lt;query.length;i++){</div><div class="line"><span class="keyword">var</span> url = <span class="string">&apos;https://www.google.co.in/search?q=&apos;</span>+query[i];</div><div class="line">casper.thenOpen(url);</div><div class="line">casper.then(addScrapedLinksToResults(query[i]));</div><div class="line">}</div><div class="line"></div><div class="line">casper.run(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</div><div class="line"><span class="comment">// echo results in some pretty fashion</span></div><div class="line"><span class="keyword">this</span>.echo(<span class="string">&apos;Done&apos;</span>);</div><div class="line"><span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> results){</div><div class="line">    <span class="keyword">this</span>.echo(results[key].length + <span class="string">&apos; links found for &apos;</span>+ key +<span class="string">&apos;:&apos;</span>);</div><div class="line">    <span class="keyword">this</span>.echo(<span class="string">&apos; - &apos;</span> + results[key].join(<span class="string">&apos;\n - &apos;</span>));</div><div class="line">}</div><div class="line"><span class="keyword">this</span>.exit();</div><div class="line">});</div></pre></td></tr></table></figure></p>
<p>This code results in proper and complete result. Based on observations made in previous run, following conclusions could be made:</p>
<ul>
<li>Keyword to URL mapping is not proper.</li>
<li>For some keywords, no results were scraped: <code>then()</code> step[the scraping step] executed before page was loaded. Above step also could be the result of this issue.</li>
<li>And apparently only one instance worked: Executing <code>exit()</code> on one casper instance caused all other instances to exit.</li>
</ul>
<h3 id="solutions"><a href="#Solutions" class="headerlink" title="Solutions:"></a>Solutions: <a href="#solutions" class="header-anchor">#</a></h3><p>To deal with the first problem jQuery is injected in every result page and with the help of <code>$.ready</code> page was scraped at the very right time. This solution eliminated both mapping and zero results problem.<br>For the second problem, status is added to each <code>casper</code> instance with the help of <code>casper.completed = false</code>. Status was then modified to true once instance associated with it has executed all the steps. All the statuses were checked before calling <code>exit()</code> and only iff statuses for all the<code>casper</code> instances are set to true, <code>exit()</code> was issued.</p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/02/22/javascript-equality-truthyness/" class="prev">上一篇</a></div><div class="copyright"><p>© 2013 - 2016 <a href="http://yoursite.com">Santosh Pingale</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>